# ПОДРОБНАЯ ИНСТРУКЦИЯ ПО ДОРАБОТКЕ ПРОЕКТА

## Уважаемый Сергей!

Я проверил Вашу работу и подготовил для Вас исправленный код с подробными комментариями на русском языке. Начало положено хорошо, но нужно доделать несколько важных моментов.

---

## ✅ ЧТО УЖЕ ИСПРАВЛЕНО

### 1. **Модели (workers/models.py)**
- Исправлены опечатки в названиях констант (CHOISE -> CHOICE, fronted -> frontend, beckend -> backend)
- Добавлено поле `employment_date` (дата приёма на работу) — **К1**
- Добавлен метод `get_work_experience_days()` для вычисления стажа в днях — **К6**
- Добавлены комментарии к каждому полю и методу
- Улучшена структура моделей Desk и Employee

### 2. **Представления (workers/views.py)**
- Исправлено представление `home()` — теперь выводит общее количество и 4 последних сотрудников — **К3, К4**
- Исправлено представление `list()` — добавлена пагинация по 10 элементов — **К5**
- Исправлено представление `detail()` — используется `get_object_or_404` — **К6**
- Убраны дублирующие импорты
- Добавлены подробные комментарии к каждой функции

### 3. **Шаблоны**
- **index.html** — главная страница с общим количеством и карточками 4 последних сотрудников — **К2, К3, К4**
- **personal.html** — список с пагинацией и карточками всех сотрудников — **К2, К5**
- **detail.html** — подробная страница сотрудника со всей информацией — **К6**
- Все шаблоны содержат подробные комментарии на русском

### 4. **URLs (workers/urls.py)**
- Добавлены имена для всех маршрутов (name='home', name='list', name='detail')
- Добавлены комментарии

---

## ЧТО НУЖНО ДОДЕЛАТЬ

### Шаг 1: Создать и применить миграции

После изменения модели нужно создать миграцию базы данных:

```powershell
# Перейдите в папку с проектом
cd "C:\Users\eduar\Downloads\HomeWork\HomeWork"

# Создайте миграцию
python manage.py makemigrations

# Примените миграцию
python manage.py migrate
```

**ВАЖНО**: Если Django спросит, что делать со старым полем `employment`, выберите вариант удаления старого поля.

---

### Шаг 2: Заполнить базу данных тестовыми данными

Чтобы проверить работу, нужны сотрудники в базе данных:

1. Запустите сервер:
```powershell
python manage.py runserver
```

2. Откройте админку: http://127.0.0.1:8000/admin/

3. Войдите под своим аккаунтом (если нет, создайте: `python manage.py createsuperuser`)

4. Добавьте минимум 15-20 сотрудников с разными данными:
   - ФИО
   - Пол
   - Навыки (frontend, backend, testing)
   - Уровень навыков (1-10)
   - Дата приёма на работу (разные даты!)
   - Фото (если есть)

---

### Шаг 3: Реализовать валидатор для столов (К8)

Сейчас валидатор в модели написан, но не работает, потому что не связаны модели Person и Desk.

**Что нужно сделать:**

1. Добавьте в модель `Person` поле для связи со столом:

```python
# В файле workers/models.py, в классе Person, добавь поле:
desk = models.ForeignKey(
    'Desk',
    on_delete=models.SET_NULL,
    null=True,
    blank=True,
    verbose_name='Рабочий стол',
    related_name='employees'
)
```

2. Исправьте метод `clean()` в классе `Person`:

```python
def clean(self):
    """Валидатор: тестировщики и разработчики не могут сидеть рядом."""
    super().clean()
    
    # Проверяем только если назначен стол
    if not self.desk:
        return
    
    # Определяем, кто является разработчиком
    developer_skills = ['frontend', 'backend']
    is_developer = self.skills in developer_skills
    is_tester = self.skills == 'testing'
    
    # Если сотрудник не разработчик и не тестировщик, валидация не нужна
    if not (is_developer or is_tester):
        return
    
    # Находим номера соседних столов
    neighbor_desk_numbers = [
        self.desk.number - 1,
        self.desk.number + 1
    ]
    
    # Ищем сотрудников за соседними столами
    neighbors = Person.objects.filter(
        desk__number__in=neighbor_desk_numbers
    ).exclude(pk=self.pk)  # Исключаем самого себя
    
    # Проверяем каждого соседа
    for neighbor in neighbors:
        neighbor_is_developer = neighbor.skills in developer_skills
        neighbor_is_tester = neighbor.skills == 'testing'
        
        # Если тестировщик рядом с разработчиком - ошибка!
        if (is_tester and neighbor_is_developer) or (is_developer and neighbor_is_tester):
            raise ValidationError(
                f"Нельзя размещать тестировщиков и разработчиков за соседними столами! "
                f"За столом №{neighbor.desk.number} сидит {neighbor.get_skills_display()}."
            )
```

3. Создайте и примените миграцию:
```powershell
python manage.py makemigrations
python manage.py migrate
```

4. В админке добавьте столы (Desk) с номерами 1, 2, 3, 4, 5 и т.д.

5. Назначьте сотрудникам столы и проверьте валидацию!

---

### Шаг 4: Оптимизация запросов (К7)

Для оптимизации запросов используй `select_related()` и `prefetch_related()`.

**Где применить:**

В файле `workers/views.py`, в функции `detail()`:

```python
def detail(request, pk):
    template_name = 'HomeWork/detail.html'
    
    # К7: Оптимизация - загружаем связанный стол за один запрос
    person = get_object_or_404(
        Person.objects.select_related('desk'),
        pk=pk
    )
    
    context = {
        'person': person,
    }
    
    return render(request, template_name, context)
```

**Объяснение:** `select_related('desk')` загружает информацию о столе вместе с сотрудником за один SQL-запрос вместо двух.

---

### Шаг 5: Отформатировать код (К9)

Установите и примените Black для форматирования:

```powershell
# Установите Black
pip install black

# Отформатируйте все файлы Python в проекте
black .

# Или только конкретные файлы
black workers/models.py workers/views.py
```

Также установите и примените isort для сортировки импортов:

```powershell
# Установите isort
pip install isort

# Отсортируйте импорты
isort .
```

---

## ЧЕКЛИСТ ВЫПОЛНЕНИЯ

Отметьте галочками, что уже сделано:

- [ ] Создали и применили миграции
- [ ] Добавили 15-20 сотрудников в базу данных
- [ ] Проверили главную страницу — показывается общее количество
- [ ] Проверили главную страницу — показываются 4 последних сотрудника
- [ ] Проверили список сотрудников — работает пагинация
- [ ] Проверили детальную страницу — показывается вся информация
- [ ] Добавили поле `desk` в модель Person
- [ ] Реализовали и проверили валидатор для столов (К8)
- [ ] Применили оптимизацию запросов (К7)
- [ ] Отформатировали код через Black и isort (К9)

---

## КРИТЕРИИ ОЦЕНИВАНИЯ (напоминание)

| Критерий | Баллов | Статус |
|----------|--------|--------|
| К1: Поле даты приёма на работу | 1 | Готово |
| К2: Карточки с полной информацией | 1 | Готово |
| К3: Общее количество сотрудников | 1 | Готово |
| К4: 4 последних нанятых | 1 | Готово |
| К5: Пагинация по 10 | 1 | Готово |
| К6: Детальная страница | 1 | Готово |
| К7: Оптимизация запросов | 3 | Нужно доделать |
| К8: Валидатор столов | 1 | Нужно доделать |
| К9: PEP8 и Django style | 1 | Нужно доделать |

**Текущий прогресс: 6/11 баллов**
**После доработки: 11/11 баллов**

---

## ПОЛЕЗНЫЕ СОВЕТЫ

### Как проверить пагинацию:
- Откройте http://127.0.0.1:8000/list/
- Если сотрудников больше 10, увидите кнопки "Вперёд", "Назад"
- В адресной строке появится ?page=2, ?page=3 и т.д.

### Как проверить валидатор:
1. Создайте в админке несколько столов (Desk): номера 1, 2, 3
2. Назначьте Frontend-разработчика на стол 1
3. Попробуйте назначить Тестировщика на стол 2 -> должна появиться ошибка!
4. Назначьте другого Frontend на стол 2 -> всё в порядке!

### Как посмотреть SQL-запросы (для оптимизации):
```python
# Временно добавь в settings.py
DEBUG_TOOLBAR_CONFIG = {
    'SHOW_TOOLBAR_CALLBACK': lambda request: True,
}
```
Установите django-debug-toolbar (он уже в INSTALLED_APPS):
```powershell
pip install django-debug-toolbar
```

---

## ЕСЛИ ЧТО-ТО НЕ РАБОТАЕТ

### Ошибка "No such table: workers_person"
-> Не применены миграции. Выполните: `python manage.py migrate`

### Ошибка "name 'home' is not defined"
-> Проверьте импорты в urls.py: `from .views import home, list, detail`

### Страница пустая (нет сотрудников)
-> Добавьте сотрудников через админку: http://127.0.0.1:8000/admin/

### Не показывается фото
-> Проверьте настройки MEDIA_ROOT и MEDIA_URL в settings.py
-> В urls.py главного проекта должно быть:
```python
from django.conf import settings
from django.conf.urls.static import static

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

---

## ЧТО НОВОГО ВЫ УЗНАЛИ

1. **Django ORM методы:**
   - `.count()` — подсчёт записей
   - `.order_by('-field')` — сортировка (минус = обратный порядок)
   - `[:4]` — ограничение количества (slicing)
   - `select_related()` — оптимизация запросов

2. **Пагинация:**
   - `Paginator(queryset, per_page)` — создание пагинатора
   - `page_obj.has_next` — проверка наличия следующей страницы
   - Использование в шаблонах

3. **Валидация:**
   - Метод `clean()` — пользовательская валидация
   - `ValidationError` — выброс ошибки
   - Проверка связанных объектов

4. **Шаблоны Django:**
   - `{{ object.method }}` — вызов методов модели
   - `{{ field|filter }}` — использование фильтров
   - `{% if %}` — условия в шаблонах
   - `{% for %}` — циклы в шаблонах

---

## ЗАКЛЮЧЕНИЕ

Ваша работа имеет хорошую основу! Основные элементы уже реализованы и работают. Осталось только:
1. Доделать валидатор (К8)
2. Добавить оптимизацию запросов (К7)
3. Отформатировать код (К9)

Следуйте инструкциям выше шаг за шагом, и у Вас всё получится!

**Удачи в работе!**

---

*P.S. Все изменения уже внесены в файлы проекта. Вам нужно только выполнить шаги 1-5 из раздела "ЧТО НУЖНО ДОДЕЛАТЬ".*
