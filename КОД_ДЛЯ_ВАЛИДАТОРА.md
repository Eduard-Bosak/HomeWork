# ГОТОВЫЙ КОД ДЛЯ ДОРАБОТКИ ВАЛИДАТОРА

## ВАЖНО: Этот файл содержит готовые фрагменты кода для копирования

---

## Шаг 1: Добавить поле desk в модель Person

### Откройте файл: `workers/models.py`

### Найдите класс `Person` и добавьте поле ПОСЛЕ поля `employment_date`:

```python
employment_date = models.DateField(
    'Дата приёма на работу',
    auto_now=False,
    auto_now_add=False,
    null=True,
    blank=True,
    help_text='Дата, когда сотрудник был принят на работу'
)

# ========================================
# ДОБАВЬТЕ ЭТУ ЧАСТЬ (связь со столом для валидатора К8)
# ========================================
desk = models.ForeignKey(
    'Desk',
    on_delete=models.SET_NULL,
    null=True,
    blank=True,
    verbose_name='Рабочий стол',
    related_name='employees',
    help_text='Номер рабочего стола сотрудника'
)
```

---

## Шаг 2: Заменить метод clean() в классе Person

### В том же файле `workers/models.py`, найдите метод `clean()` в классе `Person`

### УДАЛИТЕ старый код:

```python
def clean(self):
    super().clean()
    pass  # TODO: ...
```

### ЗАМЕНИТЕ на этот код:

```python
def clean(self):
    """
    ВАЛИДАТОР К8: Проверяет, чтобы тестировщики и разработчики
    не сидели за соседними столами.
    
    КОММЕНТАРИЙ ДЛЯ СЕРГЕЯ:
    Этот метод вызывается автоматически перед сохранением объекта.
    Django сам вызовет его в админке или при вызове .save() с валидацией.
    
    ЛОГИКА:
    1. Если у сотрудника не назначен стол — валидация не нужна
    2. Определяем тип сотрудника (разработчик или тестировщик)
    3. Находим соседние столы (номер-1 и номер+1)
    4. Проверяем навыки соседей
    5. Если тестировщик рядом с разработчиком — выдаём ошибку
    """
    super().clean()
    
    # Если стол не назначен, проверять нечего
    if not self.desk:
        return
    
    # Определяем категории навыков
    developer_skills = ['frontend', 'backend']  # Разработчики
    
    # Определяем, кто текущий сотрудник
    is_developer = self.skills in developer_skills
    is_tester = self.skills == 'testing'
    
    # Если не разработчик и не тестировщик (например, менеджер проекта)
    # то валидация не нужна
    if not (is_developer or is_tester):
        return
    
    # Вычисляем номера соседних столов
    neighbor_desk_numbers = [
        self.desk.number - 1,  # Стол слева
        self.desk.number + 1   # Стол справа
    ]
    
    # Ищем всех сотрудников за соседними столами
    # .exclude(pk=self.pk) — исключаем самого себя из проверки
    neighbors = Person.objects.filter(
        desk__number__in=neighbor_desk_numbers
    ).exclude(pk=self.pk)
    
    # Проверяем каждого соседа
    for neighbor in neighbors:
        # Определяем тип соседа
        neighbor_is_developer = neighbor.skills in developer_skills
        neighbor_is_tester = neighbor.skills == 'testing'
        
        # Проверяем конфликт:
        # 1. Текущий — тестировщик, сосед — разработчик
        # 2. Текущий — разработчик, сосед — тестировщик
        if (is_tester and neighbor_is_developer) or \
           (is_developer and neighbor_is_tester):
            
            # Выбрасываем ошибку валидации
            raise ValidationError(
                f"Нельзя размещать тестировщиков и разработчиков за соседними столами! "
                f"За столом №{neighbor.desk.number} сидит "
                f"{neighbor.name} ({neighbor.get_skills_display()}). "
                f"Пожалуйста, выберите другой стол."
            )
```

---

## Шаг 3: Обновить admin.py для работы с desk

### Откройте файл: `workers/admin.py`

### Найдите класс `PersonAdmin` и добавьте поле `desk`:

```python
@admin.register(Person)
class PersonAdmin(admin.ModelAdmin):
    list_display = (
        'id',
        'is_on_main',
        'name',
        'skills',
        'skill_level',
        'employment_date',
        'desk'  # ДОБАВЬТЕ ЭТО ПОЛЕ
    )
    list_editable = ('skills', 'skill_level', 'is_on_main')
    search_fields = ('id', 'name', 'sex', 'skills', 'skill_level', 'description')
    list_filter = ('name', 'skills', 'desk')  # ДОБАВЬТЕ desk в фильтры
    list_display_links = ('id', 'name',)

    resources_classes = [PersonResource]
```

---

## Шаг 4: Зарегистрировать модель Desk в admin

### В том же файле `workers/admin.py`, ДОБАВЬТЕ В КОНЕЦ:

```python
# ========================================
# РЕГИСТРАЦИЯ МОДЕЛИ DESK (столы)
# ========================================
from .models import Desk  # Добавьте этот импорт вверху файла

@admin.register(Desk)
class DeskAdmin(admin.ModelAdmin):
    """Админка для управления рабочими столами."""
    list_display = ('number', 'get_employee_name', 'get_employee_skills')
    list_display_links = ('number',)
    ordering = ('number',)
    
    def get_employee_name(self, obj):
        """Показывает имя сотрудника за столом."""
        employee = obj.employees.first()
        return employee.name if employee else '—'
    get_employee_name.short_description = 'Сотрудник'
    
    def get_employee_skills(self, obj):
        """Показывает навыки сотрудника за столом."""
        employee = obj.employees.first()
        return employee.get_skills_display() if employee else '—'
    get_employee_skills.short_description = 'Навыки'
```

---

## Шаг 5: Создать и применить миграции

### В терминале PowerShell выполните:

```powershell
# Перейдите в папку проекта
cd "C:\Users\eduar\Downloads\HomeWork\HomeWork"

# Создайте миграцию
python manage.py makemigrations workers

# Если Django спросит про изменения, выберите вариант 1 или 2 (по ситуации)

# Примените миграцию
python manage.py migrate
```

---

## Шаг 6: Добавить данные для тестирования

### Запустите сервер:

```powershell
python manage.py runserver
```

### Откройте админку: http://127.0.0.1:8000/admin/

### Создайте столы:

1. Перейдите в "Столы" (Desk)
2. Добавьте столы с номерами: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10

### Протестируйте валидатор:

**ТЕСТ 1: Разработчик рядом с разработчиком (должно работать)**
1. Назначьте Frontend-разработчика на стол 1
2. Назначьте Backend-разработчика на стол 2
3. Должно сохраниться без ошибок

**ТЕСТ 2: Разработчик рядом с тестировщиком (должна быть ошибка)**
1. Назначьте Frontend-разработчика на стол 3
2. Попробуйте назначить Тестировщика на стол 4
3. Должна появиться ошибка!

**ТЕСТ 3: Тестировщик рядом с тестировщиком (должно работать)**
1. Назначьте Тестировщика на стол 5
2. Назначьте другого Тестировщика на стол 6
3. Должно сохраниться без ошибок

**ТЕСТ 4: Менеджер проекта может сидеть рядом с кем угодно**
1. Назначьте Frontend-разработчика на стол 7
2. Назначьте Менеджера проекта на стол 8
3. Должно сохраниться без ошибок

---

## Шаг 7: Оптимизация запросов (К7)

### Откройте файл: `workers/views.py`

### Найдите функцию `detail` и ЗАМЕНИТЕ её:

```python
@login_required
def detail(request, pk):
    """
    КОММЕНТАРИЙ ДЛЯ СЕРГЕЯ:
    К7: Оптимизация запросов через select_related('desk')
    
    ЧТО ЭТО ДАЁТ:
    Без оптимизации Django сделает 2 запроса к БД:
    1. Запрос для получения Person
    2. Запрос для получения связанного Desk
    
    С select_related делается только 1 запрос с JOIN,
    что быстрее и эффективнее!
    """
    template_name = 'HomeWork/detail.html'
    
    # К7: Оптимизация - загружаем связанный стол за один запрос
    person = get_object_or_404(
        Person.objects.select_related('desk'),
        pk=pk
    )
    
    context = {
        'person': person,
    }
    
    return render(request, template_name, context)
```

---

## Шаг 8: Обновить шаблон detail.html для показа стола

### Откройте файл: `templates/HomeWork/detail.html`

### Найдите блок с номером стола и ЗАМЕНИТЕ:

Найдите:
```html
<div class="info-row">
    <div class="info-label">Номер стола:</div>
    <div class="info-value">
        <!-- TODO: Добавить связь с моделью Place -->
        <em>Не указан (требуется доработка модели)</em>
    </div>
</div>
```

ЗАМЕНИТЕ на:
```html
<div class="info-row">
    <div class="info-label">Номер стола:</div>
    <div class="info-value">
        {% if person.desk %}
            <strong>Стол №{{ person.desk.number }}</strong>
        {% else %}
            <em>Не назначен</em>
        {% endif %}
    </div>
</div>
```

---

## Шаг 9: Форматирование кода (К9)

### Установите инструменты:

```powershell
pip install black isort
```

### Отформатируйте код:

```powershell
# Форматирование через Black
black workers/models.py
black workers/views.py
black workers/admin.py

# Сортировка импортов
isort workers/models.py
isort workers/views.py
isort workers/admin.py
```

---

## ПРОВЕРКА ВЫПОЛНЕНИЯ

После всех шагов проверьте:

- [ ] Создана и применена миграция с полем `desk`
- [ ] В админке появился раздел "Столы"
- [ ] Можно назначить сотрудника на стол
- [ ] Валидатор работает (ошибка при назначении тестировщика рядом с разработчиком)
- [ ] На детальной странице показывается номер стола
- [ ] Код отформатирован через Black и isort
- [ ] Нет ошибок при запуске сервера

---

## ПОЗДРАВЛЯЮ!

Если всё работает — Вы выполнили **ВСЕ 11 баллов** задания!

**Отличная работа!**
